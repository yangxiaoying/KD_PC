<!DOCTYPE html>
<html>
<head>
    <%- include('../layouts/headLayout', {}) %>
    <link rel="stylesheet" type="text/css" href="/css/reglog/reglog.css"/>
    <script src="/js/jquery.enplaceholder.js" type="text/javascript" charset="utf-8"></script>
</head>
<body class="bg2">
<div class="register">
    <div class="header">
        <a href="/" target="_blank" class="left"><img src="/images/reglog/rl-logo2.png"/></a>
        <img class="right" src="/images/reglog/rl-logo3.png"/>
    </div>
    <!--注册主体-->
    <div class="rebody">
        <h1>会员注册</h1>
        <div class="frame">
            <div class="itemWrap">
                <div class="item name">
                    <label for="name"></label>
                    <input type="text" id="phoneNum" placeholder="请输入手机号"/>
                </div>
                <p class="error"></p>
            </div>

            <div class="itemWrap">
                <div class="item psw">
                    <label for="psw"></label>
                    <input type="password" id="psw" placeholder="请输入6-20位数字字母或常用符号,字母区分大小写"/>
                </div>
                <p class="error"></p>
            </div>

            <div class="itemWrap">
                <div class="item yzm">
                    <label for="yzm"></label>
                    <input id="yzm" type="text"/>
                    <a id="sendCaptcha" href="javascript:;" class="yzm status1">获取短信验证码<!--再次发送（48秒）--></a>
                </div>
                <p class="error"></p>
            </div>

            <a id="register" href="javascript:;" class="reBtn">注&nbsp;册</a>
            <div class="checkbox"><input id="hiddenCheckbox" type="checkbox" style="display: none;"/>我已阅读并同意<a
                        href="">《看典使用协议、隐私政策》</a></div>
            <div class="fastlogin">
                <h2>快速登录</h2>
                <div class="ways">
                    <a href="" class="qq"></a>
                    <a href="" class="wechat"></a>
                </div>
            </div>
        </div>
        <div class="bottom">已有看典账号或中国知网账号 ，<a href="/userCenter/login">立即登录</a></div>
    </div>
    <!--注册成功-->
    <div class="reSuccess" style="display: none;">
        <div class="sucTips">
            <h1>恭喜你，注册成功！</h1>
            <div class="btns">
                <a href="/">进入看典</a>
                <a href="/recharge/home">充值中心</a>
            </div>
        </div>
        <div class="setBox" id="setBox">
            <!--兴趣推荐-->
            <div class="setTop s1">
                <div class="tit">选择感兴趣的分类，让经典与你不期而遇<span>（信息保密，仅供内容推荐使用）</span></div>
                <div class="showBox" id="showBox">
                    <ul class="clearfix">
                        <li>
                            <img src="/images/reglog/rl-sorticon1.png"/>
                            <p>文学</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon2.png"/>
                            <p>艺术</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon3.png"/>
                            <p>思想文化</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon4.png"/>
                            <p>人物</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon5.png"/>
                            <p>历史</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon6.png"/>
                            <p>军事</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon7.png"/>
                            <p>法律</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon8.png"/>
                            <p>生活休闲</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon9.png"/>
                            <p>育儿</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon10.png"/>
                            <p>孕产</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon11.png"/>
                            <p>职场</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon12.png"/>
                            <p>财富</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                        <li>
                            <img src="/images/reglog/rl-sorticon13.png"/>
                            <p>科普</p>
                            <span class="cover"></span>
                            <span class="icon"></span>
                        </li>
                    </ul>
                    <a href="javascript:;" class="show">展开<img src="/images/reglog/rl-icon16.png"></a>
                </div>
            </div>
            <!--性别选择-->
            <div class="setTop s2" style="display: none;">
                <div class="tit">让我们更懂你，你的性别是？<span>（信息保密，仅供内容推荐使用）</span></div>
                <div class="showBox">
                    <ul>
                        <li class="female">女</li>
                        <li class="male">男</li>
                    </ul>
                </div>
            </div>
            <!--年龄选择-->
            <div class="setTop s3" style="display: none;">
                <div class="tit">让我们更懂你，你的年龄是？<span>（信息保密，仅供内容推荐使用）</span></div>
                <div class="showBox">
                    <ul class="clearfix">
                        <li>2010年以后<span></span></li>
                        <li>2000—2010年<span></span></li>
                        <li>1990—1999年<span></span></li>
                        <li>1980—1989年<span></span></li>
                        <li>1970—1979年<span></span></li>
                        <li>1960年以前<span></span></li>
                    </ul>
                </div>
            </div>
            <!--底部一致-->
            <div class="setBottom">
                <a href="javascript:;" class="next">下一步</a>
                <a href="javascript:;" class="skip">跳过<img src="/images/reglog/rl-icon17.png"></a>
            </div>
        </div>
    </div>
    <!--设置完成-->
    <div class="setupDone" style="display: none;">
        <h1>设置完成</h1>
        <div class="links">
            <a href="/discovery" class="left">发现精彩</a>
            <a href="/" class="right">去首页</a>
        </div>
    </div>
</div>
<div class="footer color">
    <p>出版：《中国学术期刊（光盘版）》电子杂志社有限公司</p>
    <p>京ICP证040431号 <a href="https://piccache.cnki.net/index/images/gb/271.jpg" target="_blank">网络出版服务许可证(总)网出证(京)字第271号 </a>京公网安备11010802020460号</p>
</div>
<script>
    'user strict'

    $("input").placeholder()

    //兴趣选择
    // $(".s1 li").click(function () {
    //     $(this).toggleClass("toggle")
    // })
    //兴趣选择分类展开
    $(".s1 .show").click(function () {
        $(this).siblings("ul").height("auto")
        $(this).hide()
    })
    //选择性别
    $(".s2 ul li").click(function () {
        $(this).addClass("cur").siblings().removeClass("cur")
    })
    //选择年龄
    $(".s3 ul li").click(function () {
        $(this).addClass("cur").siblings().removeClass("cur")
    })


    // 验证手机号格式
    // 返回值 -1 为空，0 格式不正确，1 正确
    function verifyPhoneNum(phoneNum) {
        if (!phoneNum) {
            return -1;
        } else if (!(/^1(3|4|5|6|7|8|9)\d{9}$/.test(phoneNum))) {
            return 0;
        } else {
            return 1;
        }
    }

    // 验证码重新发送倒数计时 time为多少秒
    function countDownTime(repeatTime, node) {
        var time = repeatTime;
        var timer = setInterval(function () {
            if (repeatTime != 0) {
                node.html('再次发送（' + repeatTime-- + '秒）');
            } else {
                clearInterval(timer);
                node.removeClass('status1').addClass('status2');
                node.html('获取短信验证码');
                console.log('repeatTime', time)
                limitSendCaptcha(time);
            }

        }, 1000)
    }

    // 验证码发送后 一分钟后才能再次发送
    function limitSendCaptcha(repeatTime) {
        sendCaptcha.click(function () {
            var $this = $(this);
            if (isRegistered == 0) {
                var errorDom = $(this).parent().parent().children('.error');
                var phoneNum = phoneNumInput.val().trim();
                if (verifyPhoneNum(phoneNum) == 1) {
                    $(this).removeClass('status2').addClass('status1');
                    var sendCaptchaUrl = '/userCenter/sendCaptcha?phoneNum=' + phoneNum;
                    $.ajax({
                        url: sendCaptchaUrl,
                        dataType: "json",
                        type: "get",
                        success: function (response) {
                            console.log(response)
                            if (response.errorCode == 1) {
                                errorDom.html('<span style="color: green;">验证码发送成功！</span>');
                                $this.unbind('click');
                                countDownTime(repeatTime, $this);
                            } else {
                                errorDom.html('该手机号获取验证码已达上限，请明天再试。');
                            }
                        },
                        error: function (error) {
                            //请求出错处理
                            console.log(error);
                        }
                    });
                } else {
                    // 手机号码有误，不发送
                }
            }

        })
    }

    var phoneNumInput = $('#phoneNum');
    var psw = $('#psw');
    var sendCaptcha = $('#sendCaptcha');
    var captcha = $('#yzm');
    var isRegistered = 1  // 1 被注册， 0 未被注册
    var pswCorrect = 0; // 1 密码格式正确， 0不正确
    var repeatTime = 5; // 短信重发时间间隔
    var register = $('#register');
    var registerPart = $('.rebody');
    var rSuccessPart = $('.reSuccess');
    var setupDone = $('.setupDone');
    var showBoxItem = $('#showBox ul li');
    var setBox = $('#setBox');
    var ageRange = ['1960年之前', '1970~1979年', '1980~1989年', '1990~1999年', '2000~2010年', '2010年以后'];
    var selectedAgeRange = '';
    var gender = 0; // 0 保密 1男 2女
    var username = '';
    var interestList = []; // 兴趣选择列表

    // 切换点击协议
    var hiddenCheckbox = $('#hiddenCheckbox');
    var isChecked = 0;  // 0 为勾选，1 勾选
    $(".checkbox").click(function () {
        $(this).toggleClass("c");
        if (hiddenCheckbox.is(":checked")) {
            isChecked = 0;
            hiddenCheckbox.attr('checked', false);
        } else {
            isChecked = 1;
            hiddenCheckbox.attr('checked', true);
        }
    })

    phoneNumInput.focus(function () {
        $(this).parent().parent().children('.error').html('');
    })
    // 校验手机号码格式和是否可以注册
    phoneNumInput.blur(function () {
        var errorDom = $(this).parent().parent().children('.error');
        var phoneNum = phoneNumInput.val().trim();
        if (verifyPhoneNum(phoneNum) == -1) {
            errorDom.html('手机号不能为空！');
            sendCaptcha.removeClass('status2').addClass('status1');
        } else if (verifyPhoneNum(phoneNum) == 0) {
            errorDom.html('请输入正确手机号');
            sendCaptcha.removeClass('status2').addClass('status1');
        } else {
            var verifyPhoneNumUrl = '/userCenter/verifyPhoneNum?phoneNum=' + phoneNum;
            $.ajax({
                url: verifyPhoneNumUrl,
                dataType: "json",
                type: "get",
                success: function (response) {
                    // console.log(response)
                    if (response.Code == 1) {
                        isRegistered = 0;
                        errorDom.html('<span style="color: green;">手机号可以注册！</span>');
                        sendCaptcha.removeClass('status1').addClass('status2');
                    } else {
                        isRegistered = 1;
                        errorDom.html('手机号已被注册！');
                    }
                },
                error: function (error) {
                    //请求出错处理
                    console.log(error);
                }
            });
        }
    })
    // 密码格式验证
    psw.blur(function () {
        var errorDom = $(this).parent().parent().children('.error');
        var pswVal = psw.val().trim();
        if (!pswVal) {
            pswCorrect = 0;
            errorDom.html('密码不能为空！');
        } else if (!(/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,20}$/).test(pswVal)) {
            pswCorrect = 0;
            errorDom.html('请输入6-20位数字字母或常用符号,字母区分大小写！');
        } else {
            pswCorrect = 1;
            errorDom.html('<span style="color: green;">密码格式正确！</span>');
        }
    })
    // 手机验证码
    limitSendCaptcha(repeatTime);
    // 注册
    register.click(function () {
        // console.log(isRegistered, pswCorrect, isChecked)
        if (isRegistered == 0 && pswCorrect == 1 && isChecked == 1) {
            var phoneNum = phoneNumInput.val().trim();
            username = phoneNum;
            var password = psw.val().trim();
            var captchaValue = captcha.val();
            var registerUrl = '/userCenter/signIn?phoneNum=' + phoneNum + '&password=' + password + '&captcha=' + captchaValue + '&platform=kdpc';
            $.ajax({
                url: registerUrl,
                dataType: "json",
                type: "get",
                success: function (response) {
                    // console.log(response)
                    if (response.errorCode == 1) {
                        interestList = response.interest;
                        registerPart.remove();
                        rSuccessPart.show();
                    } else {
                        captcha.parent().parent().children('.error').html(response.errormessage);
                    }
                },
                error: function (error) {
                    //请求出错处理
                    console.log(error);
                }
            });
        }
    })

    // 选择感兴趣
    showBoxItem.click(function () {
        $(this).toggleClass("toggle");
        // var index = showBoxItem.index($(this));
        if ($(this).hasClass('toggle')) {
            $(this).attr('data-interested', 1);
            // interestArr.push(letterStr[index]);
        } else {
            $(this).attr('data-interested', 0);
            // interestArr.splice(index, 1);
        }
        // console.log('兴趣选择：', index, $(this).hasClass('toggle'), letterStr[index], interestArr);
    })

    // 选择性别
    $('.s2 .showBox ul li').click(function () {
        var index = $('.s2 .showBox ul li').index($(this));
        if (index == 0) {
            gender = 2;
        } else if (index == 1) {
            gender = 1;
        } else {
            gender = 0;
        }
    })

    // 选择年龄
    $('.s3 .showBox ul li').click(function () {
        var index = $('.s3 .showBox ul li').index($(this));
        selectedAgeRange = ageRange[index];
    })

    $('.setBottom .next,.setBottom .skip').click(function () {
        // 选择兴趣
        if (setBox.children('.s1').css('display') == 'block') {
            var interestStr = '';
            var letterStr = 'ABCDEFGHIJKLM';
            showBoxItem.each(function (index, el) {
                if ($(this).attr('data-interested') == 1) {
                    interestStr += letterStr[index] + ',';
                }
            })
            // 去除末尾的，
            interestStr = interestStr.substring(0, interestStr.length - 1);
            // 保存用户兴趣选择
            if ($(this)[0].className == 'next') {
                var addUserCategoryUrl = '/userCenter/addUserCategory?cateids=' + interestStr + '&username=' + username;
                $.ajax({
                    url: addUserCategoryUrl,
                    dataType: "json",
                    type: "get",
                    success: function (response) {
                        var resData = JSON.parse(response);
                        // console.log(resData)
                        if (resData.code == 0) {
                            setBox.children('.s1').remove();
                            setBox.children('.s2').show();
                        } else {
                            console.log('添加用户兴趣分类失败！')
                            setBox.children('.s1').remove();
                            setBox.children('.s2').show();
                        }
                    },
                    error: function (error) {
                        //请求出错处理
                        console.log(error);
                    }
                });
            } else {
                registerPart.remove();
                rSuccessPart.show();
            }

        } else
        // 选择性别
        if (setBox.children('.s2').css('display') == 'block') {
            setBox.children('.s2').remove();
            setBox.children('.s3').show();
        } else
        // 选择年龄段
        if (setBox.children('.s3').css('display') == 'block') {
            if ($(this)[0].className == 'next') {
                var updateUserInfoUrl = '/userCenter/updateUserInfo?age=' + selectedAgeRange + '&gender=' + gender + '&username=' + username;
                $.ajax({
                    url: updateUserInfoUrl,
                    dataType: "json",
                    type: "get",
                    success: function (response) {
                        var resData = JSON.parse(response);
                        console.log(resData)
                        if (resData.code == 0) {
                            // location.href = '/';
                            rSuccessPart.remove();
                            setupDone.show();
                        } else {
                            console.log('修改用户信息失败！')
                            registerPart.remove();
                            rSuccessPart.show();
                        }
                    },
                    error: function (error) {
                        //请求出错处理
                        console.log(error);
                    }
                });
            } else {
                registerPart.remove();
                rSuccessPart.show();
            }
        }

    })


</script>
</body>
</html>